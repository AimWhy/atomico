{"version":3,"file":"use-state-generator.js","sources":["src/use-state-generator/use-state-generator.js"],"sourcesContent":["import { useState, useMemo, useEffect } from \"../core/core\";\r\nimport { isFunction } from \"../core/utils\";\r\nimport { ARRAY_EMPTY } from \"../core/constants\";\r\nconst promiseIgnore = new Promise(() => {});\r\n\r\nexport const CONTINUE = Symbol();\r\n\r\nexport function delay(ms) {\r\n\treturn new Promise(resolve => setTimeout(() => resolve(CONTINUE), ms));\r\n}\r\n\r\nexport function useStateGenerator(stream, initialState, vars = ARRAY_EMPTY) {\r\n\tlet [value, setValue] = useState(() => createState(initialState));\r\n\tuseEffect(() => value.cancel, []);\r\n\r\n\tvalue.stream = stream;\r\n\r\n\treturn [\r\n\t\tvalue.state,\r\n\t\tuseMemo(\r\n\t\t\t() =>\r\n\t\t\t\tvalue.send(() => {\r\n\t\t\t\t\tsetValue(value);\r\n\t\t\t\t}),\r\n\t\t\tvars\r\n\t\t)\r\n\t];\r\n}\r\n\r\nfunction consumer(value, process, id, subscribe) {\r\n\treturn Promise.resolve(value).then(value => {\r\n\t\tif (isFunction(value)) {\r\n\t\t\treturn consumer(value(process.state), process, id, subscribe);\r\n\t\t}\r\n\r\n\t\tif (typeof value == \"object\" && isFunction(value.next)) {\r\n\t\t\treturn new Promise(resolve => {\r\n\t\t\t\tfunction scan(generator) {\r\n\t\t\t\t\tPromise.resolve(generator.next(process.state)).then(\r\n\t\t\t\t\t\t({ value, done }) =>\r\n\t\t\t\t\t\t\tconsumer(value, process, id, subscribe).then(() =>\r\n\t\t\t\t\t\t\t\tdone ? resolve(process.state) : scan(generator)\r\n\t\t\t\t\t\t\t)\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t\tscan(value);\r\n\t\t\t});\r\n\t\t}\r\n\t\treturn process.next(value, subscribe, id);\r\n\t});\r\n}\r\n\r\nfunction createState(state) {\r\n\tlet currentID = 0;\r\n\tlet process = { state, next, cancel, send };\r\n\r\n\tfunction next(value, subscribe, id) {\r\n\t\tif (id != currentID) return promiseIgnore;\r\n\t\tif (value != CONTINUE) {\r\n\t\t\tprocess.state = value;\r\n\t\t\tsubscribe && subscribe(value);\r\n\t\t}\r\n\t\treturn process.state;\r\n\t}\r\n\tfunction cancel() {\r\n\t\tcurrentID++;\r\n\t}\r\n\tfunction send(subscribe) {\r\n\t\treturn consumer(process.stream, process, ++currentID, subscribe);\r\n\t}\r\n\r\n\treturn process;\r\n}\r\n"],"names":[],"mappings":"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"}